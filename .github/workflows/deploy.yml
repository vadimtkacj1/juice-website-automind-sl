name: Deploy to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          # Build-time env vars (if needed for build)
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://your-domain.com' }}

      - name: Create deployment package
        run: |
          mkdir -p deploy
          # Copy standalone build output
          cp -r .next/standalone/* deploy/
          cp -r .next/static deploy/.next/static
          cp -r public deploy/public
          # Copy scripts for database initialization
          cp -r scripts deploy/scripts
          # Copy package.json for npm scripts
          cp package.json deploy/
          tar -czf deploy.tar.gz deploy/

      - name: Deploy to server via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          source: "deploy.tar.gz"
          target: "/opt/juice-website"

      - name: Execute deployment commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          script: |
            set -e
            cd /opt/juice-website
            # Extract deployment package
            tar -xzf deploy.tar.gz
            # Move contents from deploy/ to current directory
            cp -r deploy/* . || cp -r deploy/. .
            # Create .env file with secrets
            cat > .env << EOF
            NODE_ENV=production
            PORT=${PORT:-3000}
            RAPYD_ACCESS_KEY=${{ secrets.RAPYD_ACCESS_KEY }}
            RAPYD_SECRET_KEY=${{ secrets.RAPYD_SECRET_KEY }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            DATABASE_PATH=./juice_website.db
            EOF
            # Initialize database if it doesn't exist
            if [ ! -f "juice_website.db" ] && [ -d "scripts" ]; then
              echo "Database not found, initializing..."
              node scripts/init-database.js || echo "Database initialization skipped"
              node scripts/create-admin.js || echo "Admin creation skipped"
            fi
            # Stop existing PM2 process
            pm2 stop juice-website || true
            pm2 delete juice-website || true
            # Start with standalone server
            pm2 start server.js --name juice-website --update-env
            pm2 save
            # Clean up
            rm -rf deploy deploy.tar.gz
            echo "âœ… Deployment completed successfully!"

      - name: Health check
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.DEPLOYMENT_URL }}" ]; then
            sleep 10
            curl -f "${{ secrets.DEPLOYMENT_URL }}/api/health" && echo "Health check passed!" || echo "Health check failed (non-critical)"
          else
            echo "DEPLOYMENT_URL not set, skipping health check"
          fi

