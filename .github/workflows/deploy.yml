name: Deploy to Production

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master
    tags:
      - 'v*'

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production
          # Build-time env vars (if needed for build)
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'https://your-domain.com' }}

      - name: Create deployment package
        run: |
          mkdir -p deploy
          # Verify standalone build output exists
          if [ ! -d ".next/standalone" ]; then
            echo "Error: .next/standalone directory not found. Build may have failed."
            exit 1
          fi
          # Copy standalone build output (includes server.js, .next/static, public, node_modules)
          echo "Copying standalone build output..."
          cp -r .next/standalone/* deploy/
          # Ensure scripts directory exists for database initialization
          if [ -d "scripts" ] && [ ! -d "deploy/scripts" ]; then
            cp -r scripts deploy/scripts
          fi
          # Verify critical files exist
          if [ ! -f "deploy/server.js" ]; then
            echo "Error: server.js not found in standalone output"
            exit 1
          fi
          echo "Deployment package created successfully"
          tar -czf deploy.tar.gz deploy/

      - name: Deploy to server via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          command_timeout: 300s
          source: "deploy.tar.gz"
          target: "/opt/juice-website"
        continue-on-error: false
        env:
          SCP_DEBUG: true

      - name: Execute deployment commands
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 60s
          command_timeout: 300s
          script: |
            set -e
            cd /opt/juice-website
            # Extract deployment package
            tar -xzf deploy.tar.gz
            # Move contents from deploy/ to current directory
            cp -r deploy/* . || cp -r deploy/. .
            # Create .env file with secrets
            cat > .env << EOF
            NODE_ENV=production
            PORT=80
            HOSTNAME=0.0.0.0
            RAPYD_ACCESS_KEY=${{ secrets.RAPYD_ACCESS_KEY }}
            RAPYD_SECRET_KEY=${{ secrets.RAPYD_SECRET_KEY }}
            PAYPLUS_API_KEY=${{ secrets.PAYPLUS_API_KEY }}
            PAYPLUS_SECRET_KEY=${{ secrets.PAYPLUS_SECRET_KEY }}
            PAYPLUS_PAGE_UID=${{ secrets.PAYPLUS_PAGE_UID }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            DATABASE_PATH=./juice_website.db
            DEPLOYMENT_URL=${{ secrets.DEPLOYMENT_URL }}
            EOF
            # Initialize database if it doesn't exist
            if [ ! -f "juice_website.db" ] && [ -d "scripts" ]; then
              echo "Database not found, initializing..."
              node scripts/init-database.js || echo "Database initialization skipped"
              node scripts/create-admin.js || echo "Admin creation skipped"
            fi
            # Check if PM2 is installed
            if ! command -v pm2 &> /dev/null; then
              echo "PM2 not found, installing..."
              npm install -g pm2
            fi
            
            # Stop existing PM2 process
            pm2 stop juice-website || true
            pm2 delete juice-website || true
            
            # Allow Node.js to bind to port 80 without root (requires setcap)
            echo "Setting capabilities for port 80..."
            NODE_PATH=$(which node)
            if [ -n "$NODE_PATH" ]; then
              sudo setcap 'cap_net_bind_service=+ep' "$NODE_PATH" || echo "⚠ setcap failed, trying alternative method"
            fi
            
            # Check what files exist
            echo "Checking deployment files..."
            ls -la server.js .next/standalone/server.js 2>/dev/null || echo "Checking for server files..."
            
            # Export environment variables from .env file
            set -a
            [ -f .env ] && source .env
            set +a
            
            # Ensure we're in the right directory
            cd /opt/juice-website
            
            # Start application - check if standalone server.js exists, otherwise use npm start
            if [ -f "server.js" ]; then
              echo "✓ Found server.js, starting with PM2 on port 80"
              PORT=80 HOSTNAME=0.0.0.0 pm2 start server.js --name juice-website --update-env
            elif [ -f ".next/standalone/server.js" ]; then
              echo "✓ Found .next/standalone/server.js, starting with PM2 on port 80"
              PORT=80 HOSTNAME=0.0.0.0 pm2 start .next/standalone/server.js --name juice-website --update-env
            else
              echo "⚠ No standalone server found, checking for package.json..."
              if [ -f "package.json" ]; then
                echo "Installing production dependencies..."
                npm ci --production --omit=dev || npm install --production --omit=dev
                echo "Starting with npm start on port 80"
                PORT=80 HOSTNAME=0.0.0.0 pm2 start npm --name juice-website -- start --update-env
              else
                echo "❌ ERROR: No server.js, .next/standalone/server.js, or package.json found!"
                echo "Deployment files:"
                ls -la /opt/juice-website/ | head -20
                exit 1
              fi
            fi
            
            # Save PM2 configuration
            pm2 save
            
            # Wait for server to start
            echo "Waiting for server to start..."
            sleep 10
            
            # Check PM2 status
            echo "PM2 Status:"
            pm2 status
            
            # Check PM2 logs for errors
            echo "Recent PM2 logs:"
            pm2 logs juice-website --lines 20 --nostream || echo "Could not get logs"
            
            # Check if port is listening
            echo "Checking if server is listening on port 80..."
            sudo netstat -tlnp | grep :80 || sudo ss -tlnp | grep :80 || echo "Port check command not available"
            
            # Check if another service is using port 80
            echo "Checking for processes using port 80..."
            sudo lsof -i :80 || echo "lsof not available"
            
            # Test local connection with retries
            echo "Testing server connection..."
            for i in {1..5}; do
              if curl -f http://localhost/api/health 2>/dev/null; then
                echo "✓ Server is responding on port 80"
                break
              else
                echo "Attempt $i/5: Server not responding yet, waiting..."
                sleep 3
              fi
            done
            
            # Final check
            if ! curl -f http://localhost/api/health 2>/dev/null; then
              echo "⚠ WARNING: Server not responding after all attempts"
              echo "Check PM2 logs: pm2 logs juice-website"
              echo "Check PM2 status: pm2 status"
              echo "Check if port 80 is in use: sudo lsof -i :80"
              echo "Check environment: cat .env"
            fi
            # Clean up
            rm -rf deploy deploy.tar.gz
            echo "✅ Deployment completed successfully!"

      - name: Health check
        continue-on-error: true
        run: |
          if [ -n "${{ secrets.DEPLOYMENT_URL }}" ]; then
            sleep 10
            # Try both http and https
            curl -f "http://${{ secrets.DEPLOYMENT_URL }}/api/health" && echo "Health check passed!" || \
            curl -f "https://${{ secrets.DEPLOYMENT_URL }}/api/health" && echo "Health check passed!" || \
            echo "Health check failed (non-critical)"
          else
            echo "DEPLOYMENT_URL not set, skipping health check"
          fi

