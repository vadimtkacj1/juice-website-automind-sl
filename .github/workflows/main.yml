name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Lint and Test
  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || true

      - name: Type check
        run: npx tsc --noEmit || true

  # Build Application
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
          # Build-time environment variables (optional, for validation)
          RAPYD_ACCESS_KEY: ${{ secrets.RAPYD_ACCESS_KEY }}
          RAPYD_SECRET_KEY: ${{ secrets.RAPYD_SECRET_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}

  # Build and Push Docker Image
  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            RAPYD_ACCESS_KEY=${{ secrets.RAPYD_ACCESS_KEY }}
            RAPYD_SECRET_KEY=${{ secrets.RAPYD_SECRET_KEY }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          platforms: linux/amd64

  # Deploy to Server
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 120s
          source: "./docker-compose.yml"
          target: "${{ secrets.DEPLOYMENT_PATH || '/opt/juice-website' }}"
        continue-on-error: true

      - name: Verify or create docker-compose.yml
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 120s
          script: |
            APP_PATH="${DEPLOYMENT_PATH:-/opt/juice-website}"
            cd ${APP_PATH}
            
            if [ ! -f 'docker-compose.yml' ]; then
              echo "docker-compose.yml not found, creating it..."
              REPO_NAME="${GITHUB_REPOSITORY:-vadimtkacj1/juice-website-automind-sl}"
              echo "Using repository: ${REPO_NAME}"
              cat > docker-compose.yml << EOF
            version: '3.8'
            
            services:
              nextjs-app:
                image: ghcr.io/${REPO_NAME}:latest
                container_name: juice-website
                restart: unless-stopped
                ports:
                  - "80:80"
                environment:
                  - NODE_ENV=production
                  - PORT=80
                  - RAPYD_ACCESS_KEY=\${RAPYD_ACCESS_KEY}
                  - RAPYD_SECRET_KEY=\${RAPYD_SECRET_KEY}
                  - PAYPLUS_API_KEY=\${PAYPLUS_API_KEY}
                  - PAYPLUS_SECRET_KEY=\${PAYPLUS_SECRET_KEY}
                  - PAYPLUS_PAGE_UID=\${PAYPLUS_PAGE_UID}
                  - TELEGRAM_BOT_TOKEN=\${TELEGRAM_BOT_TOKEN}
                  - SESSION_SECRET=\${SESSION_SECRET}
                  - DATABASE_PATH=/app/data/juice_website.db
                  - DEPLOYMENT_URL=\${DEPLOYMENT_URL}
                  - HOSTNAME=0.0.0.0
                volumes:
                  - ./data:/app/data
                  - ./public/uploads:/app/public/uploads
                healthcheck:
                  test: ["CMD", "node", "-e", "require('http').get('http://localhost:80/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
                networks:
                  - juice-network
            
            networks:
              juice-network:
                driver: bridge
            EOF
              echo "✓ Created docker-compose.yml"
            else
              echo "✓ docker-compose.yml already exists"
            fi
            ls -lh docker-compose.yml

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOYMENT_PATH: ${{ secrets.DEPLOYMENT_PATH }}
          DEPLOYMENT_URL: ${{ secrets.DEPLOYMENT_URL }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 120s
          command_timeout: 300s
          script: |
            set -e
            APP_PATH="${DEPLOYMENT_PATH:-/opt/juice-website}"
            cd ${APP_PATH}
            
            # Verify docker-compose.yml exists
            if [ ! -f 'docker-compose.yml' ]; then
              echo '❌ docker-compose.yml not found in ${APP_PATH}!'
              echo 'Files in directory:'
              ls -la
              exit 1
            fi
            echo '✓ docker-compose.yml found'
            
            # Create required directories
            mkdir -p data public/uploads
            chmod 755 data public/uploads
            
            # Initialize database ONLY if it doesn't exist
            echo "Checking if database exists..."
            if [ ! -f "data/juice_website.db" ]; then
              echo "Database not found, initializing..."
              
              # Copy scripts into container temporarily for initialization
              docker cp scripts juice-website:/app/scripts 2>/dev/null || echo "Scripts already in container"
              
              # Create data directory in container
              docker exec juice-website mkdir -p /app/data || true
              
              # Initialize database
              echo "Creating database tables..."
              docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/init-database.js || {
                echo "⚠ Database initialization failed, trying alternative method..."
                # Fallback: create database file first
                docker exec juice-website touch /app/data/juice_website.db
                docker exec juice-website chmod 666 /app/data/juice_website.db
                docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/init-database.js
              }
              
              # Create admin user
              echo "Creating admin user..."
              docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/create-admin.js || echo "⚠ Admin creation failed or admin already exists"
              
              echo "✅ Database initialized successfully!"
            else
              echo "✓ Database already exists, skipping initialization"
            fi
            
            # Create/update .env file
            cat > .env << EOF
            NODE_ENV=production
            PORT=80
            RAPYD_ACCESS_KEY=${{ secrets.RAPYD_ACCESS_KEY }}
            RAPYD_SECRET_KEY=${{ secrets.RAPYD_SECRET_KEY }}
            PAYPLUS_API_KEY=${{ secrets.PAYPLUS_API_KEY }}
            PAYPLUS_SECRET_KEY=${{ secrets.PAYPLUS_SECRET_KEY }}
            PAYPLUS_PAGE_UID=${{ secrets.PAYPLUS_PAGE_UID }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            DEPLOYMENT_URL=${{ secrets.DEPLOYMENT_URL }}
            GITHUB_REPOSITORY=${{ github.repository }}
            DATABASE_PATH=/app/data/juice_website.db
            EOF
            
            # Export environment variables for docker-compose
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export RAPYD_ACCESS_KEY="${{ secrets.RAPYD_ACCESS_KEY }}"
            export RAPYD_SECRET_KEY="${{ secrets.RAPYD_SECRET_KEY }}"
            export PAYPLUS_API_KEY="${{ secrets.PAYPLUS_API_KEY }}"
            export PAYPLUS_SECRET_KEY="${{ secrets.PAYPLUS_SECRET_KEY }}"
            export PAYPLUS_PAGE_UID="${{ secrets.PAYPLUS_PAGE_UID }}"
            export TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
            export SESSION_SECRET="${{ secrets.SESSION_SECRET }}"
            export DEPLOYMENT_URL="${{ secrets.DEPLOYMENT_URL }}"
            export PORT=80
            
            # Pull latest image
            echo "Pulling latest Docker image..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest || true
            
            # Stop and remove old container completely
            echo "Stopping old container..."
            docker-compose -f docker-compose.yml down || true
            docker stop juice-website 2>/dev/null || true
            docker rm -f juice-website 2>/dev/null || true
            
            # Verify docker-compose.yml has correct image
            echo "Verifying docker-compose.yml..."
            grep -q "image:" docker-compose.yml && echo "✓ docker-compose.yml has image specified" || echo "⚠ docker-compose.yml missing image"
            cat docker-compose.yml | grep image
            
            # Start new container
            echo "Starting new container with docker-compose..."
            if ! docker-compose -f docker-compose.yml up -d --remove-orphans; then
              echo "❌ docker-compose up failed!"
              echo "Checking docker-compose logs..."
              docker-compose -f docker-compose.yml logs || true
              exit 1
            fi
            echo "✓ Container started successfully"
            
            # Wait for container to be running and ready
            echo "Waiting for container to be ready..."
            CONTAINER_READY=false
            for i in {1..20}; do
              # Check if container exists and is running
              if docker ps --format '{{.Names}}' | grep -q '^juice-website$'; then
                # Test if container is ready to accept commands
                if docker exec juice-website echo "ready" >/dev/null 2>&1; then
                  CONTAINER_READY=true
                  echo "✓ Container is running and ready (attempt $i)"
                  docker ps | grep juice-website
                  break
                else
                  echo "Container exists but not ready yet (attempt $i/20)..."
                  sleep 2
                fi
              else
                echo "Waiting for container to start (attempt $i/20)..."
                sleep 2
              fi
            done
            
            if [ "$CONTAINER_READY" = true ]; then
              # Initialize database ONLY if it doesn't exist
              echo "Checking if database exists..."
              if [ ! -f "data/juice_website.db" ]; then
                echo "Database not found, initializing..."
                
                # Copy scripts into container if needed
                echo "Copying scripts to container..."
                docker cp scripts juice-website:/app/scripts 2>/dev/null || echo "⚠ Could not copy scripts (may already exist)"
                
                # Create data directory in container
                echo "Creating data directory..."
                docker exec juice-website mkdir -p /app/data 2>/dev/null || true
                
                # Initialize database with retries
                echo "Creating database tables..."
                DB_INIT_SUCCESS=false
                for retry in {1..3}; do
                  if docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/init-database.js 2>/dev/null; then
                    DB_INIT_SUCCESS=true
                    echo "✓ Database tables created"
                    break
                  else
                    echo "Database init attempt $retry/3 failed, retrying..."
                    sleep 3
                  fi
                done
                
                if [ "$DB_INIT_SUCCESS" != true ]; then
                  echo "⚠ Database initialization failed, trying alternative method..."
                  # Create database file first
                  docker exec juice-website touch /app/data/juice_website.db 2>/dev/null || true
                  docker exec juice-website chmod 666 /app/data/juice_website.db 2>/dev/null || true
                  # Try one more time
                  if docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/init-database.js 2>/dev/null; then
                    echo "✓ Database tables created (alternative method)"
                  else
                    echo "⚠ Database initialization still failed, but continuing..."
                  fi
                fi
                
                # Create admin user
                echo "Creating admin user..."
                docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/create-admin.js 2>/dev/null || echo "⚠ Admin creation failed or admin already exists"
                
                echo "✅ Database initialization completed!"
              else
                echo "✓ Database already exists, skipping initialization"
              fi
              
              # Configure Nginx to proxy to Docker container
              echo "Configuring Nginx..."
              
              # Check if nginx is installed
              if command -v nginx &> /dev/null; then
                echo "✓ Nginx is installed"
                
                # Create nginx config directory if it doesn't exist
                mkdir -p /etc/nginx/sites-available
                mkdir -p /etc/nginx/sites-enabled
                mkdir -p /etc/nginx/ssl
                
                # Check if SSL certificates exist
                if [ -f "/etc/nginx/ssl/cert.pem" ] && [ -f "/etc/nginx/ssl/key.pem" ]; then
                  echo "✓ SSL certificates found, configuring HTTPS..."
                  # Create nginx configuration with HTTPS support
                  printf '%s\n' \
                    '# HTTP server - redirect to HTTPS' \
                    'server {' \
                    '    listen 80;' \
                    '    listen [::]:80;' \
                    '    server_name _;' \
                    '    ' \
                    '    location /.well-known/acme-challenge/ {' \
                    '        root /var/www/html;' \
                    '    }' \
                    '    ' \
                    '    location / {' \
                    '        return 301 https://$host$request_uri;' \
                    '    }' \
                    '}' \
                    '' \
                    '# HTTPS server' \
                    'server {' \
                    '    listen 443 ssl http2;' \
                    '    listen [::]:443 ssl http2;' \
                    '    server_name _;' \
                    '    ' \
                    '    ssl_certificate /etc/nginx/ssl/cert.pem;' \
                    '    ssl_certificate_key /etc/nginx/ssl/key.pem;' \
                    '    ssl_protocols TLSv1.2 TLSv1.3;' \
                    '    ssl_ciphers HIGH:!aNULL:!MD5;' \
                    '    ssl_prefer_server_ciphers on;' \
                    '    ' \
                    '    location / {' \
                    '        proxy_pass http://localhost:80;' \
                    '        proxy_http_version 1.1;' \
                    '        proxy_set_header Upgrade $http_upgrade;' \
                    '        proxy_set_header Connection "upgrade";' \
                    '        proxy_set_header Host $host;' \
                    '        proxy_set_header X-Real-IP $remote_addr;' \
                    '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
                    '        proxy_set_header X-Forwarded-Proto $scheme;' \
                    '        proxy_set_header X-Forwarded-Host $host;' \
                    '        proxy_set_header X-Forwarded-Port $server_port;' \
                    '        proxy_cache_bypass $http_upgrade;' \
                    '        proxy_buffering off;' \
                    '        proxy_connect_timeout 60s;' \
                    '        proxy_send_timeout 60s;' \
                    '        proxy_read_timeout 60s;' \
                    '    }' \
                    '    ' \
                    '    location /api/health {' \
                    '        proxy_pass http://localhost:80/api/health;' \
                    '        proxy_set_header Host $host;' \
                    '        access_log off;' \
                    '    }' \
                    '}' > /etc/nginx/sites-available/juice-website
                else
                  echo "⚠ SSL certificates not found, configuring HTTP only..."
                  echo "  To enable HTTPS, place certificates at:"
                  echo "    /etc/nginx/ssl/cert.pem"
                  echo "    /etc/nginx/ssl/key.pem"
                  # Create HTTP-only configuration
                  printf '%s\n' \
                    '# HTTP server - proxy to Docker container' \
                    'server {' \
                    '    listen 80;' \
                    '    listen [::]:80;' \
                    '    server_name _;' \
                    '    ' \
                    '    location /.well-known/acme-challenge/ {' \
                    '        root /var/www/html;' \
                    '    }' \
                    '    ' \
                    '    location / {' \
                    '        proxy_pass http://localhost:80;' \
                    '        proxy_http_version 1.1;' \
                    '        proxy_set_header Upgrade $http_upgrade;' \
                    '        proxy_set_header Connection "upgrade";' \
                    '        proxy_set_header Host $host;' \
                    '        proxy_set_header X-Real-IP $remote_addr;' \
                    '        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;' \
                    '        proxy_set_header X-Forwarded-Proto $scheme;' \
                    '        proxy_set_header X-Forwarded-Host $host;' \
                    '        proxy_set_header X-Forwarded-Port $server_port;' \
                    '        proxy_cache_bypass $http_upgrade;' \
                    '        proxy_buffering off;' \
                    '        proxy_connect_timeout 60s;' \
                    '        proxy_send_timeout 60s;' \
                    '        proxy_read_timeout 60s;' \
                    '    }' \
                    '    ' \
                    '    location /api/health {' \
                    '        proxy_pass http://localhost:80/api/health;' \
                    '        proxy_set_header Host $host;' \
                    '        access_log off;' \
                    '    }' \
                    '}' > /etc/nginx/sites-available/juice-website
                fi
                
                # Enable site by creating symlink
                rm -f /etc/nginx/sites-enabled/default
                rm -f /etc/nginx/sites-enabled/juice-website
                ln -sf /etc/nginx/sites-available/juice-website /etc/nginx/sites-enabled/juice-website
                
                # Test nginx configuration
                if nginx -t 2>/dev/null; then
                  echo "✓ Nginx configuration is valid"
                  # Reload nginx
                  systemctl reload nginx 2>/dev/null || service nginx reload 2>/dev/null || echo "⚠ Could not reload nginx (may need manual reload)"
                  echo "✓ Nginx configured and reloaded"
                else
                  echo "⚠ Nginx configuration test failed, but continuing..."
                  nginx -t || true
                fi
              else
                echo "⚠ Nginx not installed, skipping nginx configuration"
              fi
            else
              echo "❌ Container is NOT running!"
              echo "Checking stopped containers:"
              docker ps -a | grep juice-website
              echo ""
              echo "Container logs (last 50 lines):"
              docker logs juice-website --tail 50 || echo "Could not get logs"
              echo ""
              echo "❌ Deployment failed - container did not start!"
              exit 1
            fi
            
            # Show container status
            echo ""
            echo "Container details:"
            docker-compose -f docker-compose.yml ps
            
            # Check container logs for errors
            echo ""
            echo "Container logs (last 30 lines):"
            docker logs juice-website --tail 30
            
            # Check if port 80 is listening
            echo ""
            echo "Checking if port 80 is listening..."
            netstat -tlnp | grep :80 || ss -tlnp | grep :80 || echo "⚠ Port 80 not found"
            
            # Test local connection with retries
            echo ""
            echo "Testing local connection to http://localhost/api/health..."
            for i in {1..5}; do
              if curl -f http://localhost/api/health 2>/dev/null; then
                echo "✓ Server is responding on port 80!"
                break
              else
                echo "Attempt $i/5: Server not responding yet, waiting..."
                sleep 5
              fi
            done
            
            # Final check
            if ! curl -f http://localhost/api/health 2>/dev/null; then
              echo "⚠ WARNING: Server not responding after all attempts"
              echo "Check logs: docker logs juice-website"
            fi
            
            # Clean up old images
            echo "Cleaning up old images..."
            docker image prune -af --filter "until=24h" || true
            
            # Health check
            if [ -n "${DEPLOYMENT_URL}" ]; then
              echo "Waiting for application to be ready..."
              sleep 10
              echo "Testing ${DEPLOYMENT_URL}/api/health..."
              curl -f ${DEPLOYMENT_URL}/api/health && echo "✓ Health check passed!" || echo "⚠ Health check failed (may need more time)"
            else
              echo "DEPLOYMENT_URL not set, skipping external health check"
            fi
            
            echo ""
            echo "✅ Deployment completed!"
            echo "If website is not accessible, check:"
            echo "1. Container logs: docker logs juice-website"
            echo "2. Container status: docker ps"
            echo "3. Port 80: netstat -tlnp | grep :80"
            echo "4. Firewall: sudo ufw status"
