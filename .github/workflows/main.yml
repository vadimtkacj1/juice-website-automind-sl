name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

env:
  NODE_VERSION: '18'
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  # Lint and Test
  lint:
    name: Lint and Type Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint || true

      - name: Type check
        run: npx tsc --noEmit || true

  # Build Application
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: lint
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build Next.js application
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_TELEMETRY_DISABLED: 1
          # Build-time environment variables (optional, for validation)
          RAPYD_ACCESS_KEY: ${{ secrets.RAPYD_ACCESS_KEY }}
          RAPYD_SECRET_KEY: ${{ secrets.RAPYD_SECRET_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}

  # Build and Push Docker Image
  docker-build:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push'
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=ref,event=branch
            type=ref,event=pr
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=production
            RAPYD_ACCESS_KEY=${{ secrets.RAPYD_ACCESS_KEY }}
            RAPYD_SECRET_KEY=${{ secrets.RAPYD_SECRET_KEY }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
          platforms: linux/amd64,linux/arm64

  # Deploy to Server
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    needs: docker-build
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')
    environment:
      name: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Copy docker-compose.yml to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 120s
          source: "./docker-compose.yml"
          target: "${{ secrets.DEPLOYMENT_PATH || '/opt/juice-website' }}"
        continue-on-error: true

      - name: Verify or create docker-compose.yml
        uses: appleboy/ssh-action@v1.0.3
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 120s
          script: |
            APP_PATH="${DEPLOYMENT_PATH:-/opt/juice-website}"
            cd ${APP_PATH}
            
            if [ ! -f 'docker-compose.yml' ]; then
              echo "docker-compose.yml not found, creating it..."
              REPO_NAME="${GITHUB_REPOSITORY:-vadimtkacj1/juice-website-automind-sl}"
              echo "Using repository: ${REPO_NAME}"
              cat > docker-compose.yml << EOF
            version: '3.8'
            
            services:
              nextjs-app:
                image: ghcr.io/${REPO_NAME}:latest
                container_name: juice-website
                restart: unless-stopped
                ports:
                  - "80:80"
                environment:
                  - NODE_ENV=production
                  - PORT=80
                  - RAPYD_ACCESS_KEY=\${RAPYD_ACCESS_KEY}
                  - RAPYD_SECRET_KEY=\${RAPYD_SECRET_KEY}
                  - PAYPLUS_API_KEY=\${PAYPLUS_API_KEY}
                  - PAYPLUS_SECRET_KEY=\${PAYPLUS_SECRET_KEY}
                  - PAYPLUS_PAGE_UID=\${PAYPLUS_PAGE_UID}
                  - TELEGRAM_BOT_TOKEN=\${TELEGRAM_BOT_TOKEN}
                  - SESSION_SECRET=\${SESSION_SECRET}
                  - DATABASE_PATH=/app/data/juice_website.db
                  - DEPLOYMENT_URL=\${DEPLOYMENT_URL}
                  - HOSTNAME=0.0.0.0
                volumes:
                  - ./data:/app/data
                  - ./public/uploads:/app/public/uploads
                healthcheck:
                  test: ["CMD", "node", "-e", "require('http').get('http://localhost:80/api/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 40s
                networks:
                  - juice-network
            
            networks:
              juice-network:
                driver: bridge
            EOF
              echo "✓ Created docker-compose.yml"
            else
              echo "✓ docker-compose.yml already exists"
            fi
            ls -lh docker-compose.yml

      - name: Deploy to server via SSH
        uses: appleboy/ssh-action@v1.0.3
        env:
          DEPLOYMENT_PATH: ${{ secrets.DEPLOYMENT_PATH }}
          DEPLOYMENT_URL: ${{ secrets.DEPLOYMENT_URL }}
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT || 22 }}
          timeout: 120s
          command_timeout: 300s
          script: |
            set -e
            APP_PATH="${DEPLOYMENT_PATH:-/opt/juice-website}"
            cd ${APP_PATH}
            
            # Verify docker-compose.yml exists
            if [ ! -f 'docker-compose.yml' ]; then
              echo '❌ docker-compose.yml not found in ${APP_PATH}!'
              echo 'Files in directory:'
              ls -la
              exit 1
            fi
            echo '✓ docker-compose.yml found'
            
            # Create required directories
            mkdir -p data public/uploads
            chmod 755 data public/uploads
            
            # Initialize database ONLY if it doesn't exist
            echo "Checking if database exists..."
            if [ ! -f "data/juice_website.db" ]; then
              echo "Database not found, initializing..."
              
              # Copy scripts into container temporarily for initialization
              docker cp scripts juice-website:/app/scripts 2>/dev/null || echo "Scripts already in container"
              
              # Create data directory in container
              docker exec juice-website mkdir -p /app/data || true
              
              # Initialize database
              echo "Creating database tables..."
              docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/init-database.js || {
                echo "⚠ Database initialization failed, trying alternative method..."
                # Fallback: create database file first
                docker exec juice-website touch /app/data/juice_website.db
                docker exec juice-website chmod 666 /app/data/juice_website.db
                docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/init-database.js
              }
              
              # Create admin user
              echo "Creating admin user..."
              docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/create-admin.js || echo "⚠ Admin creation failed or admin already exists"
              
              echo "✅ Database initialized successfully!"
            else
              echo "✓ Database already exists, skipping initialization"
            fi
            
            # Create/update .env file
            cat > .env << EOF
            NODE_ENV=production
            PORT=80
            RAPYD_ACCESS_KEY=${{ secrets.RAPYD_ACCESS_KEY }}
            RAPYD_SECRET_KEY=${{ secrets.RAPYD_SECRET_KEY }}
            PAYPLUS_API_KEY=${{ secrets.PAYPLUS_API_KEY }}
            PAYPLUS_SECRET_KEY=${{ secrets.PAYPLUS_SECRET_KEY }}
            PAYPLUS_PAGE_UID=${{ secrets.PAYPLUS_PAGE_UID }}
            TELEGRAM_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            SESSION_SECRET=${{ secrets.SESSION_SECRET }}
            DEPLOYMENT_URL=${{ secrets.DEPLOYMENT_URL }}
            GITHUB_REPOSITORY=${{ github.repository }}
            DATABASE_PATH=/app/data/juice_website.db
            EOF
            
            # Export environment variables for docker-compose
            export GITHUB_REPOSITORY="${{ github.repository }}"
            export RAPYD_ACCESS_KEY="${{ secrets.RAPYD_ACCESS_KEY }}"
            export RAPYD_SECRET_KEY="${{ secrets.RAPYD_SECRET_KEY }}"
            export PAYPLUS_API_KEY="${{ secrets.PAYPLUS_API_KEY }}"
            export PAYPLUS_SECRET_KEY="${{ secrets.PAYPLUS_SECRET_KEY }}"
            export PAYPLUS_PAGE_UID="${{ secrets.PAYPLUS_PAGE_UID }}"
            export TELEGRAM_BOT_TOKEN="${{ secrets.TELEGRAM_BOT_TOKEN }}"
            export SESSION_SECRET="${{ secrets.SESSION_SECRET }}"
            export DEPLOYMENT_URL="${{ secrets.DEPLOYMENT_URL }}"
            export PORT=80
            
            # Pull latest image
            echo "Pulling latest Docker image..."
            docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest || true
            
            # Stop and remove old container completely
            echo "Stopping old container..."
            docker-compose -f docker-compose.yml down || true
            docker stop juice-website 2>/dev/null || true
            docker rm -f juice-website 2>/dev/null || true
            
            # Verify docker-compose.yml has correct image
            echo "Verifying docker-compose.yml..."
            grep -q "image:" docker-compose.yml && echo "✓ docker-compose.yml has image specified" || echo "⚠ docker-compose.yml missing image"
            cat docker-compose.yml | grep image
            
            # Start new container
            echo "Starting new container with docker-compose..."
            if ! docker-compose -f docker-compose.yml up -d --remove-orphans; then
              echo "❌ docker-compose up failed!"
              echo "Checking docker-compose logs..."
              docker-compose -f docker-compose.yml logs || true
              exit 1
            fi
            echo "✓ Container started successfully"
            
            # Wait for container to start
            echo "Waiting for container to start..."
            sleep 10
            
            # Check if container is actually running
            echo "Checking container status..."
            if docker ps | grep -q juice-website; then
              echo "✓ Container is running"
              docker ps | grep juice-website
              
              # Initialize database ONLY if it doesn't exist
              echo "Checking if database exists..."
              if [ ! -f "data/juice_website.db" ]; then
                echo "Database not found, initializing..."
                
                # Copy scripts into container if needed
                docker cp scripts juice-website:/app/scripts 2>/dev/null || echo "Scripts already in container"
                
                # Create data directory in container
                docker exec juice-website mkdir -p /app/data || true
                
                # Initialize database
                echo "Creating database tables..."
                docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/init-database.js || {
                  echo "⚠ Database initialization failed, trying alternative method..."
                  docker exec juice-website touch /app/data/juice_website.db
                  docker exec juice-website chmod 666 /app/data/juice_website.db
                  docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/init-database.js
                }
                
                # Create admin user
                echo "Creating admin user..."
                docker exec -e DATABASE_PATH=/app/data/juice_website.db juice-website node scripts/create-admin.js || echo "⚠ Admin creation failed or admin already exists"
                
                echo "✅ Database initialized successfully!"
              else
                echo "✓ Database already exists, skipping initialization"
              fi
            else
              echo "❌ Container is NOT running!"
              echo "Checking stopped containers:"
              docker ps -a | grep juice-website
              echo ""
              echo "Container logs (last 50 lines):"
              docker logs juice-website --tail 50 || echo "Could not get logs"
              echo ""
              echo "❌ Deployment failed - container did not start!"
              exit 1
            fi
            
            # Show container status
            echo ""
            echo "Container details:"
            docker-compose -f docker-compose.yml ps
            
            # Check container logs for errors
            echo ""
            echo "Container logs (last 30 lines):"
            docker logs juice-website --tail 30
            
            # Check if port 80 is listening
            echo ""
            echo "Checking if port 80 is listening..."
            netstat -tlnp | grep :80 || ss -tlnp | grep :80 || echo "⚠ Port 80 not found"
            
            # Test local connection with retries
            echo ""
            echo "Testing local connection to http://localhost/api/health..."
            for i in {1..5}; do
              if curl -f http://localhost/api/health 2>/dev/null; then
                echo "✓ Server is responding on port 80!"
                break
              else
                echo "Attempt $i/5: Server not responding yet, waiting..."
                sleep 5
              fi
            done
            
            # Final check
            if ! curl -f http://localhost/api/health 2>/dev/null; then
              echo "⚠ WARNING: Server not responding after all attempts"
              echo "Check logs: docker logs juice-website"
            fi
            
            # Clean up old images
            echo "Cleaning up old images..."
            docker image prune -af --filter "until=24h" || true
            
            # Health check
            if [ -n "${DEPLOYMENT_URL}" ]; then
              echo "Waiting for application to be ready..."
              sleep 10
              echo "Testing ${DEPLOYMENT_URL}/api/health..."
              curl -f ${DEPLOYMENT_URL}/api/health && echo "✓ Health check passed!" || echo "⚠ Health check failed (may need more time)"
            else
              echo "DEPLOYMENT_URL not set, skipping external health check"
            fi
            
            echo ""
            echo "✅ Deployment completed!"
            echo "If website is not accessible, check:"
            echo "1. Container logs: docker logs juice-website"
            echo "2. Container status: docker ps"
            echo "3. Port 80: netstat -tlnp | grep :80"
            echo "4. Firewall: sudo ufw status"
